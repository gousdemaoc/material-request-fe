{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component, Input, Output, ViewChild, EventEmitter } from '@angular/core';\nimport { getData } from '../../data-module/data.reducer';\nimport { fromEvent } from 'rxjs';\nimport * as DataActions from '../../data-module/state/data.actions';\nlet RequestDlgComponent = class RequestDlgComponent {\n  constructor(store) {\n    this.store = store;\n    this.closeOpenRequest = new EventEmitter();\n    this.cancelOpenRequest = new EventEmitter();\n    this.saveOpenRequest = new EventEmitter();\n    this.materials = [];\n    this.filteredMaterials = [];\n    this.msIndex = 0;\n    this.packages = [];\n    this.filteredPackages = [];\n    this.psIndex = 0;\n    this.materialRef = {\n      material: {\n        INVENTORY_ITEM_ID: 0,\n        ITEM_NO: '',\n        DESCRIPTION: '',\n        BULK_ITEM_ID: ''\n      },\n      package: {\n        CONT_TYPE: '',\n        CONT_MAX_VOL: '',\n        PKG_TYPE: '',\n        PKG_MAT: '',\n        PKG_LID_CLASS: '',\n        PKG_LINING_CLASS: '',\n        PKG_OTHER_CLASS: ''\n      },\n      quantity: 0\n    };\n    this.editQuantities = false;\n    this.showNoItemDialog = false;\n  }\n\n  ngOnInit() {\n    this.store.dispatch(DataActions.loadMaterials());\n    this.editQuantities = false;\n    this.referenceDate = new Date('January 1, 1900');\n    this.store.select(getData).subscribe(state => {\n      console.log('state', state);\n\n      if (state !== null) {\n        this.materials = state[1].products;\n        this.packages = state[1].packages; //console.log(this.materials);\n\n        this.psIndex = -1;\n        this.msIndex = -1;\n      } else {\n        this.materials = [{\n          ITEM_NO: 'TEST',\n          DESCRIPTION: 'TEST'\n        }, {\n          ITEM_NO: 'TEST',\n          DESCRIPTION: 'TEST'\n        }];\n        this.packages = [];\n      }\n    });\n    this.filteredMaterials = [];\n    this.initializeNewMaterial();\n\n    if (this.selectedRequest.request_id <= 0) {\n      this.setRequiredByDate();\n    }\n  }\n\n  ngAfterViewInit() {\n    // console.log(this.selectedRequest);\n    //if(this.selectedRequest.request_id <= 0 && this.selectedRequest.status === 'NEW')\n    if (this.selectedRequest && this.selectedRequest.request_id <= 0) {\n      fromEvent(this.pk_srch.nativeElement, 'keydown').subscribe(res => {\n        if (this.filteredPackages && this.filteredPackages.length > 0) // @ts-ignore\n          switch (res.keyCode) {\n            case 13:\n              // this.pk_srch.nativeElement.value = (this.filteredPackages && this.filteredPackages.length) ? this.filteredPackages[this.psIndex][\"CONT_TYPE\"] : this.pk_srch.nativeElement.value;\n              this.selectPackage(this.psIndex);\n              break;\n\n            case 40:\n              // @ts-ignore\n              Array.from(this.ps.nativeElement.children).map(elem => elem.classList.remove('selected'));\n              this.psIndex = this.psIndex === this.ps.nativeElement.children.length - 1 ? 0 : this.psIndex + 1;\n              if (this.ps.nativeElement.children.length > 0) this.ps.nativeElement.children[this.psIndex].setAttribute('class', 'selected');\n              break;\n\n            case 38:\n              // console.log(`Starting: ${this.psIndex}`)\n              // @ts-ignore\n              Array.from(this.ps.nativeElement.children).map(elem => elem.classList.remove('selected'));\n              this.psIndex = this.psIndex > -1 ? this.psIndex - 1 : -1; // console.log(this.psIndex);\n\n              if (this.psIndex >= 0) if (this.ps.nativeElement.children.length > 0) this.ps.nativeElement.children[this.psIndex].setAttribute('class', 'selected');\n              break;\n          }\n      });\n      fromEvent(this.pk_srch.nativeElement, 'keyup').subscribe(res => {\n        this.pk_srch.nativeElement.value = this.pk_srch.nativeElement.value.toUpperCase(); // @ts-ignore\n\n        switch (res.keyCode) {\n          case 38:\n          case 40:\n          case 13:\n            break;\n\n          default:\n            // @ts-ignore\n            const search = res.target.value.toUpperCase();\n\n            if (search && search.trim().length > 0) {\n              this.filterPackages(search);\n            } else this.filteredPackages = [];\n\n            break;\n        }\n      });\n      fromEvent(this.mat_srch.nativeElement, 'keydown').subscribe(res => {\n        if (this.filteredMaterials && this.filteredMaterials.length > 0) // @ts-ignore\n          switch (res.keyCode) {\n            case 13:\n              // console.log(`pressed enter`);\n              this.mat_srch.nativeElement.value = this.filteredMaterials && this.filteredMaterials.length ? this.filteredMaterials[this.msIndex][\"ITEM_NO\"] : this.mat_srch.nativeElement.value;\n              this.selectMaterial(this.msIndex);\n              break;\n\n            case 40:\n              // @ts-ignore\n              Array.from(this.ms.nativeElement.children).map(elem => elem.classList.remove('selected'));\n              this.msIndex = this.msIndex === this.ms.nativeElement.children.length - 1 ? 0 : this.msIndex + 1;\n              this.ms.nativeElement.children[this.msIndex].setAttribute('class', 'selected');\n              break;\n\n            case 38:\n              // console.log(`Starting: ${this.msIndex}`)\n              // @ts-ignore\n              Array.from(this.ms.nativeElement.children).map(elem => elem.classList.remove('selected'));\n              this.msIndex = this.msIndex > -1 ? this.msIndex - 1 : -1; // console.log(this.msIndex);\n\n              if (this.msIndex >= 0) this.ms.nativeElement.children[this.msIndex].setAttribute('class', 'selected');\n              break;\n          }\n      });\n      fromEvent(this.mat_srch.nativeElement, 'keyup').subscribe(res => {\n        // @ts-ignore\n        switch (res.keyCode) {\n          case 38:\n          case 40:\n          case 13:\n            break;\n\n          default:\n            this.mat_srch.nativeElement.value = this.mat_srch.nativeElement.value.toUpperCase(); // @ts-ignore\n\n            const search = res.target.value.toUpperCase();\n\n            if (search && search.trim().length > 0) {\n              this.filterMaterials(search);\n            } else this.filteredMaterials = [];\n\n            break;\n        }\n      });\n      fromEvent(this.mat_qty.nativeElement, 'input').subscribe(res => {\n        // @ts-ignore\n        this.materialRef.quantity = parseInt(res.target.value); // console.log(this.materialRef);\n      });\n    }\n  }\n\n  setRequiredByDate() {\n    let daysToAdd = 3;\n    let currentDate = new Date();\n\n    while (daysToAdd > 0) {\n      currentDate.setDate(currentDate.getDate() + 1); // Move to the next day\n      // Skip weekends (Saturday = 6, Sunday = 0)\n\n      if (currentDate.getDay() !== 0 && currentDate.getDay() !== 6) {\n        daysToAdd--;\n      }\n    }\n\n    this.selectedRequest.dtm_required = currentDate;\n  }\n\n  filterMaterials(search) {\n    //Reset the selected Index on the materials list\n    this.msIndex = -1; //Remove any selections that might be made already\n    // @ts-ignore\n\n    Array.from(this.ms.nativeElement.children).map(elem => elem.classList.remove('selected'));\n    this.filteredMaterials = this.materials.filter(mat => {\n      return mat.ITEM_NO.toUpperCase().startsWith(search.toUpperCase()) || mat.DESCRIPTION.trim().toUpperCase().startsWith(search.trim().toUpperCase());\n    }).sort((a, b) => {\n      return a[\"ITEM_NO\"].localeCompare(b[\"ITEM_NO\"]);\n    }).slice(0, 5);\n    if (this.filteredMaterials.length > 1) this.materialRef.material = undefined;else if (this.filteredMaterials.length === 1) {\n      this.msIndex = 0;\n      this.materialRef.material = this.filteredMaterials[this.msIndex]; // @ts-ignore\n\n      Array.from(this.ms.nativeElement.children).map(elem => elem.classList.remove('selected'));\n      if (this.ms.nativeElement.children[0]) this.ms.nativeElement.children[0].setAttribute('class', 'selected');\n    }\n  }\n\n  filterPackages(search) {\n    this.filteredPackages = this.packages.filter(item => {\n      return item.CONT_TYPE.toUpperCase().startsWith(search);\n    }).sort((a, b) => {\n      return a[\"CONT_TYPE\"].localeCompare(b[\"CONT_TYPE\"]);\n    }).slice(0, 5);\n    if (this.filteredPackages.length > 1) this.materialRef.package = undefined;else if (this.filteredPackages.length === 1) {\n      this.psIndex = 0;\n      this.materialRef.package = this.filteredPackages[this.psIndex]; // @ts-ignore\n\n      Array.from(this.ps.nativeElement.children).map(elem => elem.classList.remove('selected'));\n      if (this.ps.nativeElement.children[0]) this.ps.nativeElement.children[0].setAttribute('class', 'selected');\n    }\n  }\n\n  selectMaterial(index) {\n    this.mat_srch.nativeElement.value = this.filteredMaterials[index]['ITEM_NO'];\n    this.filteredMaterials = this.filteredMaterials.filter(mat => {\n      return mat.ITEM_NO == this.filteredMaterials[index]['ITEM_NO'] && mat.DESCRIPTION == this.filteredMaterials[index]['DESCRIPTION'];\n    });\n    this.materialRef.material = this.filteredMaterials && this.filteredMaterials.length ? this.filteredMaterials[0] : undefined; // console.log(this.materialRef);\n  }\n\n  selectPackage(index = 0) {\n    // console.table(this.filteredPackages);\n    // console.log(this.filteredPackages[index]['CONT_TYPE']);\n    this.pk_srch.nativeElement.value = this.filteredPackages[index]['CONT_TYPE'];\n    this.filteredPackages = this.filteredPackages.filter(pkg => {\n      return pkg.CONT_TYPE === this.pk_srch.nativeElement.value;\n    });\n    this.ps.nativeElement.children[0].setAttribute('class', 'selected');\n    this.materialRef.package = this.filteredPackages && this.filteredPackages.length ? this.filteredPackages[0] : undefined; // console.log(this.materialRef);\n  }\n\n  addLineItem() {\n    // alert('adding new line')\n    // if(this.selectedRequest.request_id === -1){\n    //   this.selectedRequest.request_id = 1;\n    // }\n    // if(this.materialRef.quantity===undefined){\n    //   this.materialRef.quantity=0;\n    // }\n    if (this.selectedRequest.lines.length < 4 && this.materialRef && this.materialRef.material && this.materialRef.package && this.materialRef.quantity && this.materialRef.quantity > 0) {\n      let requestLine = {\n        request_id: this.selectedRequest.request_id,\n        inventory_item_id: this.materialRef.material.ITEM_NO,\n        item_desc: this.materialRef.material.DESCRIPTION,\n        package_type_desc: this.materialRef.package.CONT_TYPE,\n        requested_qty: this.materialRef.quantity,\n        actual_qty: 0,\n        fulfilled_weight: 0,\n        received_qty: 0,\n        fulfilled_by: \"\",\n        received_by: \"\"\n      };\n      this.selectedRequest.lines.push(JSON.parse(JSON.stringify(requestLine)));\n      requestLine = undefined;\n      this.initializeNewMaterial();\n    } else {\n      this.showNoItemDialog = true;\n    }\n  }\n\n  deleteItem(index) {\n    this.selectedRequest.lines.splice(index, 1);\n  }\n\n  sortData(data, column) {\n    return data && data.length ? typeof data[0][column] === 'number' ? data.sort((a, b) => {\n      return a[column] - b[column];\n    }) : data.sort((a, b) => {\n      return a[column].localeCompare(b[column]);\n    }) : null;\n  }\n\n  showDate(date) {\n    if (date) return this.referenceDate.getTime() < this.parseDate(date).getTime();\n  }\n\n  parseDate(dateString) {\n    if (dateString) {\n      return new Date(dateString);\n    }\n\n    return null;\n  }\n\n  handleCloseRequest() {\n    this.closeOpenRequest.emit(this.selectedRequest);\n  }\n\n  handleCancelRequest() {\n    this.cancelOpenRequest.emit(this.selectedRequest);\n  }\n\n  handleSaveRequest() {\n    this.selectedRequest.lines.forEach(item => {\n      if (this.selectedRequest.status === 'PENDING') {\n        this.selectedRequest.dtm_fulfilled = new Date();\n        item.fulfilled_by = this.user.login;\n      } else {\n        this.selectedRequest.dtm_received = new Date();\n        item.received_by = this.user.login;\n      }\n    });\n    this.saveOpenRequest.emit(this.selectedRequest);\n  }\n\n  initializeNewMaterial() {\n    this.materialRef = {\n      material: {\n        INVENTORY_ITEM_ID: undefined,\n        ITEM_NO: '',\n        DESCRIPTION: '',\n        BULK_ITEM_ID: ''\n      },\n      package: {\n        CONT_TYPE: '',\n        CONT_MAX_VOL: '',\n        PKG_TYPE: '',\n        PKG_MAT: '',\n        PKG_LID_CLASS: '',\n        PKG_LINING_CLASS: '',\n        PKG_OTHER_CLASS: ''\n      },\n      quantity: 0\n    }; // It's not enough to initialized the object because of the functionality of the controls\n\n    if (this.mat_srch) {\n      this.mat_srch.nativeElement.value = '';\n      this.msIndex = -1;\n      this.filteredMaterials.length = 0;\n    }\n\n    if (this.pk_srch) {\n      this.pk_srch.nativeElement.value = '';\n      this.psIndex = -1;\n      this.filteredPackages.length = 0;\n    }\n\n    if (this.mat_qty) this.mat_qty.nativeElement.value = '';\n  }\n\n  closeNoItemDialog() {\n    this.showNoItemDialog = false;\n  }\n\n};\n\n__decorate([Output()], RequestDlgComponent.prototype, \"closeOpenRequest\", void 0);\n\n__decorate([Output()], RequestDlgComponent.prototype, \"cancelOpenRequest\", void 0);\n\n__decorate([Output()], RequestDlgComponent.prototype, \"saveOpenRequest\", void 0);\n\n__decorate([Input()], RequestDlgComponent.prototype, \"selectedRequest\", void 0);\n\n__decorate([Input()], RequestDlgComponent.prototype, \"user\", void 0);\n\n__decorate([ViewChild('mat_search')], RequestDlgComponent.prototype, \"mat_srch\", void 0);\n\n__decorate([ViewChild('materialSelector')], RequestDlgComponent.prototype, \"ms\", void 0);\n\n__decorate([ViewChild('pkg_search')], RequestDlgComponent.prototype, \"pk_srch\", void 0);\n\n__decorate([ViewChild('packageSelector')], RequestDlgComponent.prototype, \"ps\", void 0);\n\n__decorate([ViewChild('mat_qty')], RequestDlgComponent.prototype, \"mat_qty\", void 0);\n\nRequestDlgComponent = __decorate([Component({\n  selector: 'app-request-dlg',\n  templateUrl: './request-dlg.component.html',\n  styleUrls: ['./request-dlg.component.scss']\n})], RequestDlgComponent);\nexport { RequestDlgComponent };","map":null,"metadata":{},"sourceType":"module"}