{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component, HostListener, ViewChild } from '@angular/core';\nimport { getUser } from '../../data-module/user.reducer';\nimport { fromEvent, Subject } from 'rxjs';\nimport { take } from 'rxjs/operators';\nimport * as UserActions from '../../data-module/state/user.actions';\nimport * as DataActions from '../../data-module/state/data.actions';\nlet WelcomeComponent = class WelcomeComponent {\n  constructor(datePipe, ds, store, router, route) {\n    this.datePipe = datePipe;\n    this.ds = ds;\n    this.store = store;\n    this.router = router;\n    this.route = route;\n    this.today = new Date();\n    this.plants = [{\n      org_id: 285,\n      plant: 'TNR'\n    }, {\n      org_id: 85,\n      plant: 'TNC'\n    }];\n  }\n\n  handleKeyDown(event) {\n    if (event.key.toUpperCase() === 'ESCAPE') {\n      if (this.showDialog) {\n        if (this.showNotes) this.closeDialog();else {\n          this.closeDialog();\n          if (!this.dlgMessage) this.clearSelectedRequest();\n        }\n      } else {\n        this.closeSelectedRequest(); //this.closeDialog();\n      }\n    }\n  }\n\n  ngOnInit() {\n    const id = this.route.snapshot.queryParamMap.get('requestID'); // // console.log(`inside welcome the request ID we are looking for is: ${id}`);\n\n    this.referenceDate = new Date('January 1, 1900');\n    this.fillRequest = false;\n    this.recvRequest = false;\n    this.showNotes = false;\n    this.showDialog = false;\n    this.showReport = false;\n    this.dlgConfirm = new Subject();\n    this.version = '1.0.2';\n    this.store.select(getUser).subscribe(state => {\n      if (state && state[0] && state[0].last_name && state[0].emc_applications[0].emc_app_id == 201) {\n        this.user = state[0];\n        console.log('USER--->', this.user);\n        this.getAllRequests();\n      } else {\n        // // console.log(`we are going to nope`);\n        if (!id) {\n          // // console.log(`leaving welcome with no id`);\n          this.router.navigate(['nope']);\n        } else {\n          // // console.log(`leaving welcome with id: ${id}`);\n          this.router.navigate(['nope'], {\n            queryParams: {\n              requestID: id\n            }\n          });\n        }\n      }\n    });\n    this.store.dispatch(UserActions.loadUserInfo());\n    this.store.dispatch(DataActions.loadMaterials());\n    this.store.dispatch(DataActions.loadPackages()); // this.getAllRequests();\n    //this.filteredMaterials = [];\n  }\n\n  ngAfterViewInit() {\n    //Dude ... this search functionality is on POINT!!\n    fromEvent(this.reqFilter.nativeElement, 'keyup').subscribe(res => {\n      // @ts-ignore\n      const search = res.target.value;\n\n      if (search && search.trim().length > 0) {\n        this.requests = this.originalRequests.filter(item => {\n          const options = {\n            weekday: 'long',\n            year: 'numeric',\n            month: 'long',\n            day: 'numeric'\n          };\n          new Date().toLocaleDateString();\n          return item.request_id == search || item.status.toUpperCase().includes(search.toUpperCase()) || item.requested_by.toUpperCase().includes(search.toUpperCase()) || this.translatePlant(item.org_id).toUpperCase() == search.toUpperCase() || item.dtm_submitted.toLocaleString() == new Date(search).toLocaleString() || item.dtm_fulfilled.toLocaleString() == new Date(search).toLocaleString() || item.dtm_received.toLocaleString() == new Date(search).toLocaleString() || item.dtm_required.toLocaleString() == new Date(search).toLocaleString() || item.lines.some(l => l.inventory_item_id.toUpperCase().includes(search.toUpperCase())) || item.lines.some(l => l.item_desc.toUpperCase().includes(search.toUpperCase())) || item.lines.some(l => l.package_type_desc.toUpperCase().includes(search.toUpperCase())) || new Date(item.dtm_submitted).getFullYear() > 2019 && new Date(item.dtm_submitted).toLocaleDateString(undefined, options).toUpperCase().includes(search.toUpperCase()) || new Date(item.dtm_fulfilled).getFullYear() > 2019 && new Date(item.dtm_fulfilled).toLocaleDateString(undefined, options).toUpperCase().includes(search.toUpperCase()) || new Date(item.dtm_received).getFullYear() > 2019 && new Date(item.dtm_received).toLocaleDateString(undefined, options).toUpperCase().includes(search.toUpperCase()) || new Date(item.dtm_required).getFullYear() > 2019 && new Date(item.dtm_required).toLocaleDateString(undefined, options).toUpperCase().includes(search.toUpperCase());\n        });\n      } else {\n        this.requests = JSON.parse(JSON.stringify(this.originalRequests));\n      }\n\n      if (this.requests.length) this.sortData(this.requests, 'request_id');\n    });\n    /*fromEvent(this.search.nativeElement, 'keypress').subscribe( res => {\r\n            // @ts-ignore\r\n      const search = res.target.value;\r\n            if(this.materials && this.materials.length > 100 && search.length > 0){\r\n        this.materialSuggestions = this.materials.filter( mat => {\r\n          return (\r\n            mat.ITEM_NO.toUpperCase().startsWith(search.toUpperCase()) ||\r\n            mat.INVENTORY_ITEM_ID == search.toUpperCase() ||\r\n            mat.DESCRIPTION.trim().toUpperCase().startsWith(search.trim().toUpperCase()) ||\r\n            mat.BULK_ITEM_NO.trim().toUpperCase().startsWith(search.trim().toUpperCase())\r\n          );\r\n        });\r\n        if(this.materialSuggestions && this.materialSuggestions.length > 1)\r\n          this.sortData(this.materialSuggestions, 'DESCRIPTION')\r\n        if(this.materialSuggestions && this.materialSuggestions.length === 1){\r\n          this.selectedRequestItem = this.materialSuggestions[0].ITEM_NO\r\n          this.materialSuggestions = [];\r\n        }\r\n      \r\n              //// console.log(this.materialSuggestions);\r\n      }else {\r\n        this.materialSuggestions = [];\r\n      }\r\n    })*/\n  }\n\n  getAllRequests() {\n    // this.ds.getAllRequests().subscribe( data => {\n    // console.log(\"Fetching all open requests\")\n    this.ds.getOpenRequests().subscribe(data => {\n      this.originalRequests = this.user.emc_applications[0].emc_access_level === 1 ? data : data.filter(item => item.status === 'PENDING');\n      console.log('USER--->', this.user);\n      console.log('getAllRequests--->', this.originalRequests);\n      this.requests = JSON.parse(JSON.stringify(this.originalRequests)); // console.table(this.requests);\n\n      this.sortData(this.requests, 'request_id'); //this.sortData(this.requests, 'dtm_submitted');\n\n      if (this.route.snapshot.queryParamMap.get('requestID')) {\n        const id = parseInt(this.route.snapshot.queryParamMap.get('requestID')); // this.clearSelectedRequest();\n\n        this.selectRequestItem(id);\n      }\n    });\n  }\n\n  getRequestByDate() {\n    if (this.fromDate != undefined && this.toDate != undefined) {\n      this.ds.getAllRequestsByDate({\n        fromDate: this.fromDate,\n        toDate: this.toDate\n      }).subscribe(data => {\n        this.originalRequests = this.user.emc_applications[0].emc_access_level === 1 ? data : data.filter(item => item.status === 'PENDING');\n        console.log('USER--->', this.user);\n        console.log('getAllRequestsByDate--->', this.originalRequests);\n        this.requests = JSON.parse(JSON.stringify(this.originalRequests)); // console.table(this.requests);\n\n        this.sortData(this.requests, 'request_id'); //this.sortData(this.requests, 'dtm_submitted');\n\n        if (this.route.snapshot.queryParamMap.get('requestID')) {\n          const id = parseInt(this.route.snapshot.queryParamMap.get('requestID')); // this.clearSelectedRequest();\n\n          this.selectRequestItem(id);\n        }\n      });\n    }\n  } // Request actions\n\n\n  initializeNewRequest() {\n    this.selectedRequest = {\n      request_id: -1,\n      requested_by: `${this.user.login}`,\n      org_id: 285,\n      status: 'NEW',\n      dtm_submitted: new Date(),\n      dtm_required: new Date(),\n      dtm_fulfilled: null,\n      dtm_received: null,\n      notes: '',\n      lines: new Array()\n    };\n  }\n\n  selectRequestItem(id) {\n    try {\n      // console.log(`inside selectRequest with id: ${id}`);\n      this.selectedRequest = JSON.parse(JSON.stringify(this.requests.find(item => {\n        return item.request_id === id;\n      })));\n      this.fillRequest = this.showDate(this.selectedRequest.dtm_fulfilled);\n      this.recvRequest = this.showDate(this.selectedRequest.dtm_received); //// console.log(this.selectedRequest);\n    } catch (e) {//console.error(e.message)\n    }\n  } // Lines\n  // addLineItem (){\n  //   if(this.selectedRequest && this.selectedRequest.status === 'NEW' && this.selectedRequest.lines.length < 4 && this.selectedRequestItem && this.selectedRequestItem.trim().length > 0 && this.itemPackage && this.itemQTY > 0){\n  //     const inventory_item_id = this.materials.filter(item => item.ITEM_NO === this.selectedRequestItem).map(out => out.INVENTORY_ITEM_ID)[0] ? this.materials.filter(item => item.ITEM_NO === this.selectedRequestItem).map(out => out.INVENTORY_ITEM_ID)[0] : '';\n  //     let requestLine = {\n  //       request_id: this.selectedRequest.request_id,\n  //       inventory_item_id: inventory_item_id,\n  //       item_desc: this.selectedRequestItem,\n  //       package_type_desc: this.itemPackage,\n  //       requested_qty: this.itemQTY,\n  //       actual_qty: 0,\n  //       received_qty: 0,\n  //       fulfilled_by: \"\",\n  //       received_by: \"\"\n  //     }\n  //\n  //     this.selectedRequest.lines.push(JSON.parse(JSON.stringify(requestLine)));\n  //     requestLine = undefined;\n  //     this.itemQTY = 0;\n  //     this.itemPackage = undefined;\n  //     this.selectedRequestItem = undefined;\n  //\n  //\n  //   }\n  //   else {\n  //\n  //   }\n  //\n  // }\n  // deleteItem(index){\n  //   this.dlgMessage = `Are you sure you want to delete this row?`;\n  //   this.showDialog = true;\n  //\n  //   this.dlgConfirm.pipe(take(1)).subscribe( val=> {\n  //     if(val === true)\n  //       this.selectedRequest.lines.splice(index, 1);\n  //\n  //     this.dlgMessage = undefined;\n  //     this.showDialog = false;\n  //   });\n  //\n  // }\n  // markLinesAsFilled(){\n  //\n  //   this.selectedRequest.dtm_fulfilled = new Date();\n  //   this.selectedRequest.lines.forEach( l => {\n  //     l.fulfilled_by = this.user.login;\n  //   });\n  //\n  //   //this.selectRequestItem(request_id);\n  // }\n\n\n  markLinesAsReceived() {\n    // console.log(this.selectedRequest);\n    this.selectedRequest.dtm_received = new Date();\n    this.selectedRequest.lines.forEach(l => {\n      l.received_by = this.user.login;\n    });\n  }\n\n  validateLines() {\n    let valid = false;\n\n    switch (this.user.emc_applications[0].emc_access_level) {\n      case 1:\n        if (this.selectedRequest.status === 'NEW' && this.selectedRequest.lines.length > 0) valid = true;else valid = this.selectedRequest.status === 'FILLED' && this.selectedRequest.lines.some(item => item.received_qty > 0);\n        break;\n\n      case 2:\n        valid = this.selectedRequest.status === 'PENDING' && this.selectedRequest.lines.some(item => item.actual_qty > 0);\n        break;\n    }\n\n    return valid;\n  } // Form actions\n\n\n  closeSelectedRequest() {\n    const id = this.selectedRequest.request_id;\n    const original = JSON.stringify(this.requests.find(r => r.request_id === id));\n    const current = JSON.stringify(this.selectedRequest);\n    this.dlgMessage = original != current ? `Are you sure you want to close the current request without saving your changes??` : `Are you sure you want to close this request?`;\n    this.showDialog = true;\n    this.dlgConfirm.pipe(take(1)).subscribe(val => {\n      if (val === true) this.clearSelectedRequest();\n      this.dlgMessage = undefined;\n      this.showDialog = false;\n    });\n  }\n\n  clearSelectedRequest() {\n    this.initializeNewRequest();\n    this.selectedRequest = undefined;\n  }\n\n  saveSelectedRequest() {\n    const action = this.selectedRequest.status === 'NEW' ? 'N' : this.selectedRequest.status === 'PENDING' ? 'P' : this.selectedRequest.status === 'FILLED' ? 'F' : this.selectedRequest.status === 'CANCELLED' ? 'C' : '';\n\n    if (this.validateLines()) {\n      this.working = true;\n      this.openDialog();\n      this.ds.saveRequest(this.selectedRequest, action).subscribe(val => {\n        // console.log(val);\n        this.clearSelectedRequest();\n        this.getAllRequests();\n        this.closeDialog();\n        this.working = false;\n      });\n    } else {// console.log(`there was an issue with the request object below: `);\n      // console.log(this.selectedRequest);\n    }\n  }\n\n  cancelRequest() {\n    if (this.selectedRequest.status === 'FILLED') return;else {\n      this.dlgMessage = `Are you sure you want to cancel the current request??`;\n      this.showDialog = true;\n      this.dlgConfirm.pipe(take(1)).subscribe(val => {\n        if (val === true) {\n          this.dlgMessage = undefined;\n          this.closeDialog();\n          this.working = true;\n          this.openDialog();\n          this.ds.cancelRequest(this.selectedRequest, 'C').subscribe(val => {\n            // console.log(val);\n            this.clearSelectedRequest();\n            this.getAllRequests();\n            this.closeDialog();\n            this.working = false; // if(val === 'SUCCESS'){\n            //\n            // }\n          });\n        } else {\n          this.dlgMessage = undefined;\n          this.closeDialog();\n        }\n      });\n    }\n  }\n\n  closeRequestDialog(e) {\n    this.selectedRequest = e;\n    this.closeSelectedRequest();\n  }\n\n  closeReportDialog(e) {\n    this.showReportToggle();\n  }\n\n  cancelRequestFromDialog(e) {\n    this.selectedRequest = e;\n    this.cancelRequest();\n  }\n\n  saveRequestFromDialog(e) {\n    // console.log(`inside save in welcome!`);\n    this.selectedRequest = e; // console.log(`valid? ${this.validateLines()}`);\n    // console.log(this.selectedRequest);\n\n    this.saveSelectedRequest();\n  } // Dialog actions\n\n\n  openNotes() {\n    this.dlgMessage = undefined;\n    this.showNotes = true;\n    this.openDialog();\n  }\n\n  openDialog() {\n    // console.log('inside open dialog');\n    this.showDialog = true;\n  }\n\n  closeDialog() {\n    this.showNotes = this.showDialog = false;\n  } // Utility Functions\n\n\n  showDate(date) {\n    return this.referenceDate.getTime() < this.parseDate(date).getTime();\n  }\n\n  parseDate(dateString) {\n    if (dateString) {\n      return new Date(dateString);\n    }\n\n    return null;\n  }\n\n  translatePlant(val) {\n    return this.plants.find(item => item.org_id == val).plant;\n  }\n\n  sortData(data, column) {\n    if (data && data.length) return typeof data[0][column] === 'number' ? data.sort((a, b) => {\n      return a[column] - b[column];\n    }) : data.sort((a, b) => {\n      return a[column].localeCompare(b[column]);\n    });\n  }\n\n  searchKeyUp() {\n    /*if(this.materials && this.materials.length > 100 && this.selectedRequestItem.length > 0){\r\n      this.materialSuggestions = this.materials.filter( mat => {\r\n        return (\r\n          mat.ITEM_NO.toUpperCase().startsWith(this.selectedRequestItem.toUpperCase()) ||\r\n          mat.INVENTORY_ITEM_ID == this.selectedRequestItem.toUpperCase() ||\r\n          mat.DESCRIPTION.trim().toUpperCase().startsWith(this.selectedRequestItem.trim().toUpperCase()) ||\r\n          mat.BULK_ITEM_NO.trim().toUpperCase().startsWith(this.selectedRequestItem.trim().toUpperCase())\r\n        );\r\n      });\r\n      if(this.materialSuggestions && this.materialSuggestions.length > 1)\r\n        this.sortData(this.materialSuggestions, 'DESCRIPTION')\r\n      if(this.materialSuggestions && this.materialSuggestions.length === 1){\r\n        this.selectedRequestItem = this.materialSuggestions[0].ITEM_NO\r\n        this.materialSuggestions = [];\r\n      }\r\n      //// console.log(this.materialSuggestions);\r\n    }else {\r\n      this.materialSuggestions = [];\r\n    }*/\n    if (this.selectedRequestItem.length > 0) {\n      this.selectedRequestItem = this.selectedRequestItem.toUpperCase();\n      let suggestions = this.materials.map(mat => mat.ITEM_NO).filter(mat => mat.toUpperCase().startsWith(this.selectedRequestItem)).sort();\n      if (suggestions.length > 0) this.bg.nativeElement.value = this.selectedRequestItem + suggestions[0].substring(this.selectedRequestItem.length);else this.bg.nativeElement.value = '';\n    } else this.bg.nativeElement.value = '';\n  }\n\n  blurSearch(val) {\n    if (val) this.selectedRequestItem = val.toUpperCase();else this.selectedRequestItem = this.selectedRequestItem.toUpperCase();\n    this.search.nativeElement.blur();\n    this.materialSuggestions = [];\n  }\n\n  blurMaterialSearch() {\n    if (this.bg.nativeElement.value) {\n      this.selectedRequestItem = this.bg.nativeElement.value;\n      this.bg.nativeElement.value = '';\n    }\n  }\n\n  showReportToggle() {\n    this.showReport = !this.showReport;\n  }\n\n};\n\n__decorate([HostListener('window:keydown', ['$event'])], WelcomeComponent.prototype, \"handleKeyDown\", null);\n\n__decorate([ViewChild('search')], WelcomeComponent.prototype, \"search\", void 0);\n\n__decorate([ViewChild('popup')], WelcomeComponent.prototype, \"popup\", void 0);\n\n__decorate([ViewChild('reqsearch')], WelcomeComponent.prototype, \"reqFilter\", void 0);\n\n__decorate([ViewChild('backgroundInput')], WelcomeComponent.prototype, \"bg\", void 0);\n\nWelcomeComponent = __decorate([Component({\n  selector: 'app-welcome',\n  templateUrl: './welcome.component.html',\n  styleUrls: ['./welcome.component.scss']\n})], WelcomeComponent);\nexport { WelcomeComponent };","map":null,"metadata":{},"sourceType":"module"}